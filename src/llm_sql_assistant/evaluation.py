from pathlib import Path

from llm_sql_assistant.sql_runner import run_sql


def normalize_rows(rows: list[tuple]) -> list[tuple]:
    """Normalize query output rows for stable comparison.

    Current rules:
    - Sort rows (order-insensitive comparison).
    - Keep values as-is (we will improve normalization later).

    Args:
        rows: Raw rows from database cursor.

    Returns:
        Normalized rows.
    """
    return sorted(rows)


def execution_match(db_path: Path, predicted_sql: str, gold_sql: str) -> bool:
    """Check whether predicted SQL matches gold SQL by execution results.

    Args:
        db_path: Path to SQLite database.
        predicted_sql: SQL generated by the model.
        gold_sql: Reference SQL query.

    Returns:
        True if execution results match, otherwise False.

    Raises:
        SqlExecutionError: If either query fails to execute.
    """
    predicted = run_sql(db_path=db_path, sql=predicted_sql)
    gold = run_sql(db_path=db_path, sql=gold_sql)

    predicted_rows = normalize_rows(predicted.rows)
    gold_rows = normalize_rows(gold.rows)

    return predicted_rows == gold_rows
